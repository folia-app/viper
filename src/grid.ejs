<html>

<head>
  <title>
    <%= htmlWebpackPlugin.options.title %>
  </title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="description" content="<%= htmlWebpackPlugin.options.metaDesc %>" />
<!-- 
  <% for (key in htmlWebpackPlugin.files.js) { %>
    <script src="<%= htmlWebpackPlugin.files.js[key] %>"></script>
    <% } %> -->

    
    <script  src="./p5.js"></script>
    <%= "<script>" + compilation.assets['viper.js'].source() + "</script>" %>
      <style>
        body {
          margin: 0;
          padding: 0;
        }
        .pointer{
          cursor: pointer;
          margin: 10px;
        }
        div, canvas {
          display: inline;
          margin: 0;
          padding: 0;
          /* text-align: center; */
        }
      </style>

</head>

<body>
  <% for (var i = 0; i < 100; i++) { %><div id="sketch-holder-<%= i %>"></div><% } %>
  <br>
  <button class="pointer" id="prev">prev</button>
  <button class="pointer" id="next">next</button>
  <script>
    let page = 1
    let perPage = 4
    let globalViper
    let totalVipers = 0

    // click next and increase page then call startPage
    document.getElementById("next").addEventListener("click", (e) => {
      e.preventDefault()
      page += 1
      startPage()
    })
    
    const arrayOfVipers = []
    var s = function(p) {
      const container = totalVipers % perPage
      var viper = new Viper({
        tokenId: totalVipers + 1,
        setting: "browser",
        // pattern: "random",
        maxNumberOfLines: Math.ceil(100 * (totalVipers / 806)),
        div: `sketch-holder-${container}`,
      })
      if (container == 0) {
        globalViper = viper
      }
      if (container > perPage) {
        console.error(`shouldn't be ${{totalVipers}} vipers`, totalVipers)
        return
      }
      var draw = false
      p.preload = async () => {}
      p.setup = async () => {
        await viper.setup(p)
        await viper.preload()
        draw = true
      }
      p.draw = async () => {
        if (!draw) return
        viper.draw()
      }
      const prevViper = arrayOfVipers[container]
      if (prevViper) {
        console.log('kill viper')
        prevViper.die()
      }
      arrayOfVipers[container] = viper
      totalVipers += 1
    }
    function startPage() {
      for (var i = 0; i < perPage; i++) {
        document.getElementById(`sketch-holder-${i}`).innerHTML = ""
        new p5(s, `sketch-holder-${i}`)
      }
    }

    startPage()


  </script>
</body>

</html>